name: Deploy over SSH
on:
  workflow_call:
    inputs:
      preDeployCommand:
        required: false
        type: string
      postDeployCommand:
        required: false
        type: string
jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      SSH_TARGET: ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }}
      SSH_DEPLOY_PATH: ${{ secrets.SSH_DEPLOY_PATH }}
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v3
        with:
          name: output
          path: artifact
      - name: Create .ssh directory
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KNOWN_HOSTS }}" > ~/.ssh/known_hosts
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
      - name: Run remote pre-deploy command
        if: ${{ inputs.preDeployCommand != '' }}
        run: ssh $SSH_TARGET "mkdir -p $SSH_DEPLOY_PATH; cd $SSH_DEPLOY_PATH; ${{ inputs.preDeployCommand }}"
      - name: Deploy
        run: rsync -a artifact/ $SSH_TARGET:$SSH_DEPLOY_PATH
      - name: Run remote post-deploy command
        if: ${{ inputs.postDeployCommand != '' }}
        run: ssh $SSH_TARGET "cd $SSH_DEPLOY_PATH; ${{ inputs.postDeployCommand }}"
